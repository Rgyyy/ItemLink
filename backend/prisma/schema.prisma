generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// User Models
// ============================================================================

model User {
  id              String        @id @default(uuid())
  email           String        @unique
  username        String        @unique
  passwordHash    String?       @map("password_hash")
  fullName        String?       @map("full_name")
  phone           String?
  avatarUrl       String?       @map("avatar_url")
  isVerified      Boolean       @default(false) @map("is_verified")
  isActive        Boolean       @default(true) @map("is_active")

  // 소셜 로그인 필드
  provider        AuthProvider  @default(LOCAL)
  providerId      String?       @map("provider_id")

  // 탈퇴 관련 필드
  deletedAt       DateTime?     @map("deleted_at")

  // 신뢰 시스템 필드
  tier            UserTier  @default(NEWBIE)
  isBanned        Boolean   @default(false) @map("is_banned")
  bannedUntil     DateTime? @map("banned_until")
  bannedReason    String?   @map("banned_reason")

  // 통계 필드
  totalTrades     Int       @default(0) @map("total_trades")
  cancelledTrades Int       @default(0) @map("cancelled_trades")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  role            Role      @default(USER)

  // Relations
  trades             Trade[]              @relation("UserTrades")
  comments           Comment[]
  receivedMessages   Message[]            @relation("ReceiverMessages")
  sentMessages       Message[]            @relation("SenderMessages")
  receivedReviews    Review[]             @relation("RevieweeReviews")
  sentReviews        Review[]             @relation("ReviewerReviews")
  boughtTransactions Transaction[]        @relation("BuyerTransactions")
  soldTransactions   Transaction[]        @relation("SellerTransactions")
  rating             UserRating?
  reportsMade        Report[]             @relation("ReporterReports")
  reportsReceived    Report[]             @relation("ReportedUserReports")
  processedReports   Report[]             @relation("ProcessedReports")

  @@map("users")
}

model UserRating {
  userId             String   @id @map("user_id")
  totalReviews       Int      @default(0) @map("total_reviews")
  averageRating      Decimal  @default(0) @map("average_rating") @db.Decimal(3, 2)
  totalSales         Int      @default(0) @map("total_sales")
  totalPurchases     Int      @default(0) @map("total_purchases")

  // 신규: 취소 관련 통계
  cancelledSales     Int      @default(0) @map("cancelled_sales")
  cancelledPurchases Int      @default(0) @map("cancelled_purchases")

  updatedAt          DateTime @updatedAt @map("updated_at")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_ratings")
}

// ============================================================================
// Trade Models (기존 Item 모델)
// ============================================================================

model Trade {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")

  // 게시판 타입 (거래글/자유게시판/건의게시판)
  boardType    BoardType   @default(TRADE) @map("board_type")

  // 게임 카테고리 (하드코딩된 게임명 문자열) - 거래글에만 사용
  gameCategory String?     @map("game_category")

  title        String
  description  String
  images       String[]    @default([])
  views        Int         @default(0)
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  tradeType    TradeType   @default(SELL) @map("trade_type")
  status       TradeStatus @default(AVAILABLE)

  // Relations
  user         User          @relation("UserTrades", fields: [userId], references: [id], onDelete: Cascade)
  comments     Comment[]
  transactions Transaction[]

  @@index([userId])
  @@index([boardType])
  @@index([gameCategory])
  @@index([status])
  @@index([tradeType])
  @@index([createdAt(sort: Desc)])
  @@map("trades")
}

model Comment {
  id        String   @id @default(uuid())
  tradeId   String   @map("trade_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  trade     Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("comments")
}

// ============================================================================
// Email Verification Models
// ============================================================================

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  code      String
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  verified  Boolean  @default(false)
  attempts  Int      @default(0)

  @@index([email])
  @@index([expiresAt])
  @@map("email_verifications")
}

// ============================================================================
// Transaction Models
// ============================================================================

model Transaction {
  id              String            @id @default(uuid())
  tradeId         String            @map("trade_id")
  sellerId        String            @map("seller_id")
  buyerId         String            @map("buyer_id")
  quantity        Int
  totalPrice      Decimal           @map("total_price") @db.Decimal(12, 2)
  paymentMethod   String?           @map("payment_method")
  meetingLocation String?           @map("meeting_location")
  notes           String?

  // 취소 정보
  cancelledBy     String?           @map("cancelled_by")
  cancelReason    String?           @map("cancel_reason")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  completedAt     DateTime?         @map("completed_at")

  // 5단계 거래 프로세스
  status          TransactionStatus @default(REQUESTED)

  // Relations
  messages        Message[]
  reviews         Review[]
  buyer           User              @relation("BuyerTransactions", fields: [buyerId], references: [id], onDelete: Cascade)
  trade           Trade             @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  seller          User              @relation("SellerTransactions", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([buyerId], map: "idx_transactions_buyer")
  @@index([tradeId], map: "idx_transactions_trade")
  @@index([sellerId], map: "idx_transactions_seller")
  @@map("transactions")
}

model Message {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  senderId      String      @map("sender_id")
  receiverId    String      @map("receiver_id")
  content       String
  isRead        Boolean     @default(false) @map("is_read")
  createdAt     DateTime    @default(now()) @map("created_at")
  receiver      User        @relation("ReceiverMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender        User        @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([receiverId], map: "idx_messages_receiver")
  @@index([transactionId], map: "idx_messages_transaction")
  @@map("messages")
}

// ============================================================================
// Review Models
// ============================================================================

model Review {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  reviewerId    String      @map("reviewer_id")
  revieweeId    String      @map("reviewee_id")
  rating        Int
  comment       String?
  createdAt     DateTime    @default(now()) @map("created_at")
  reviewee      User        @relation("RevieweeReviews", fields: [revieweeId], references: [id], onDelete: Cascade)
  reviewer      User        @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@unique([transactionId, reviewerId])
  @@index([revieweeId], map: "idx_reviews_reviewee")
  @@map("reviews")
}

// ============================================================================
// Report & Safety Models
// ============================================================================

model Report {
  id             String       @id @default(uuid())
  reporterId     String       @map("reporter_id")
  reportedUserId String       @map("reported_user_id")
  transactionId  String?      @map("transaction_id")

  type           ReportType
  reason         String
  evidence       String?

  status         ReportStatus @default(PENDING)
  adminNote      String?      @map("admin_note")
  processedBy    String?      @map("processed_by")
  processedAt    DateTime?    @map("processed_at")

  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  reporter       User         @relation("ReporterReports", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser   User         @relation("ReportedUserReports", fields: [reportedUserId], references: [id], onDelete: Cascade)
  processor      User?        @relation("ProcessedReports", fields: [processedBy], references: [id], onDelete: SetNull)

  @@index([reportedUserId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

// ============================================================================
// Enums
// ============================================================================

enum Role {
  USER
  ADMIN
}

enum AuthProvider {
  LOCAL
  GOOGLE
  NAVER
  KAKAO
}

enum UserTier {
  NEWBIE   // 거래 0-5건
  NORMAL   // 거래 6-20건, 평점 3.0+
  TRUSTED  // 거래 21-50건, 평점 4.0+
  VETERAN  // 거래 51건+, 평점 4.5+
}


enum BoardType {
  TRADE       // 거래글
  FREE        // 자유게시판
  SUGGESTION  // 건의게시판
  REPORT      // 신고하기
}

enum TradeType {
  SELL
  BUY
}

enum TradeStatus {
  AVAILABLE
  RESERVED
  SOLD
  CLOSED
  HIDDEN
}

enum TransactionStatus {
  REQUESTED          // 1. 거래 신청
  CONDITIONS_AGREED  // 2. 조건 확인
  ITEM_DELIVERED     // 3. 아이템 전달
  PAYMENT_COMPLETED  // 4. 입금 완료
  COMPLETED          // 5. 거래 완료
  CANCELLED          // 취소됨
}

enum ReportType {
  SCAM              // 사기
  ITEM_NOT_SENT     // 아이템 미전달
  PAYMENT_NOT_SENT  // 입금 미완료
  ABUSE             // 욕설/비방
  OTHER             // 기타
}

enum ReportStatus {
  PENDING    // 대기중
  REVIEWING  // 검토중
  RESOLVED   // 해결됨
  REJECTED   // 반려됨
}
